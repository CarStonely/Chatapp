<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    rel="stylesheet">
  
  <!-- Bootstrap CSS for Responsive Design and Components -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoY6b4UKr3oBlb2qz2H3zjE5R1nldoR4o9Bs0R0LqBMU8Y+" 
    crossorigin="anonymous">
  
  <!-- Font Awesome for Icons -->
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" 
    integrity="sha512-Fo3rlrZj/k7ujTnHq6X0iS3OECpXr+IhqMIHdzgiNjFFlz0zTFOhLLFYJzQrQIg7VHPxC4m8MkG/tybU+8/H4g==" 
    crossorigin="anonymous" 
    referrerpolicy="no-referrer" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="/static/css/profile.css">
  
  <!-- Flashed Messages Passed to JavaScript -->
  <script>
    window.flashed_messages = {{ get_flashed_messages(with_categories=true) | tojson }};
  </script>
</head>
<body>
  
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand" onclick="window.location.href='{{ url_for('chat.index') }}'">ChatApp</div>
    <div class="navbar-toggler">&#9776;</div>
    <div class="navbar-menu">
      <span>Logged in as:  <strong>{{ session['username'] }}</strong></span>
      {% if 'user_id' in session %}
        <a href="{{ url_for('auth.profile') }}">Profile</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}">Login</a>
        <a href="{{ url_for('auth.register') }}">Register</a>
      {% endif %}
      <a href="{{ url_for('chat.index') }}">Room Selector</a>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container position-relative">
    <!-- Loading Indicator for Profile Update -->
    <div id="profile-loading" class="loading-overlay">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Updating profile...</span>
      </div>
    </div>

    <!-- Profile Card -->
    <div class="profile-container">
      <h1>Profile</h1>

      <!-- Flash Messages for Error Handling and Success Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, msg in messages %}
              <div class="flash-message {{ category }}">
                <p>{{ msg }}</p>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Display User's Current Profile Picture -->
      <img src="{{ user.profile_picture or url_for('static', filename='images/default_avatar.png') }}" alt="Profile Picture" class="profile-avatar">

      <!-- Profile Update Form -->
      <form action="{{ url_for('auth.profile') }}" method="POST" enctype="multipart/form-data" class="mt-4">
        <!-- Username Field (Optional: Display but disable editing) -->
        <div class="form-group">
          <label for="username"><i class="fas fa-user"></i> Username</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            value="{{ user.username }}" 
            placeholder="Enter your username" 
            required
            readonly
            aria-required="true"
            aria-label="Username"
          >
        </div>

        <!-- Bio Field -->
        <div class="form-group">
          <label for="bio"><i class="fas fa-info-circle"></i> Bio</label>
          <textarea 
            id="bio" 
            name="bio" 
            placeholder="Write about yourself" 
            rows="4"
            aria-required="false"
            aria-label="Bio"
          >{{ user.bio or '' }}</textarea>
        </div>

        <!-- Profile Picture Upload -->
        <div class="form-group">
          <label for="profile_picture"><i class="fas fa-camera"></i> Change Avatar</label>
          <input 
            type="file" 
            id="profile_picture" 
            name="profile_picture" 
            accept="image/*"
            aria-label="Change Avatar"
          >
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn-primary" id="update-profile-btn">Update Profile</button>
      </form>

      <!-- Preview of User's Bio -->
      <div class="bio-preview mt-4">
        <h3>Your Bio:</h3>
        <p>{{ user.bio or "No bio provided yet." }}</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2024 Chat Application. Built with ❤️ for seamless conversations.</p>
  </footer>

  <!-- Bootstrap JS Bundle (includes Popper for tooltips) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+U3zY4AmoF6Ykvh+8t8enY4K+5q6E" 
    crossorigin="anonymous">
  </script>

  <!-- External JavaScript -->
  <script src="/static/js/profile.js"></script>
</body>
</html>
