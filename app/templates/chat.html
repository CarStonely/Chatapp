<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chatroom: {{ room }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Favicon -->
  <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon" />
  <script src="https://kit.fontawesome.com/c42fb6de74.js" crossorigin="anonymous"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    rel="stylesheet" 
  />

  <!-- Bootstrap CSS for Spinners and Tooltips -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoY6b4UKr3oBlb2qz2H3zjE5R1nldoR4o9Bs0R0LqBMU8Y+" 
    crossorigin="anonymous"
  />

  <!-- External CSS -->
  <link rel="stylesheet" href="/static/css/chat.css" />
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand" onclick="window.location.href='{{ url_for('chat.index') }}'">ChatApp</div>
    <div class="navbar-toggler">&#9776;</div>
    <div class="navbar-menu">
      <span>Logged in as:  <strong>{{ session['username'] }}</strong></span>
      {% if 'user_id' in session %}
        <a href="{{ url_for('auth.profile') }}">Profile</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}">Login</a>
        <a href="{{ url_for('auth.register') }}">Register</a>
      {% endif %}
      <a href="{{ url_for('chat.index') }}">Room Selector</a>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <!-- Chat Header -->
    <div class="chat-header">
      {% if dm_display_name %}
        <h1>{{ dm_display_name }}</h1>
      {% else %}
        <h1>Welcome to {{ room }}</h1>
      {% endif %}
    </div>
    <!-- Room Selection (Optional for DMs) -->
    {% if rooms and rooms|length > 0 %}
    <div class="room-selection">
      <form id="room-form">
        <label for="room-select">Switch Room:</label>
        <select id="room-select">
          {% for available_room in rooms %}
            <option value="{{ available_room }}" {% if available_room == room %}selected{% endif %}>
              {{ available_room }}
            </option>
          {% endfor %}
        </select>
      </form>
    </div>
    {% endif %}

    <!-- Chat Content -->
    <div class="chat-content">
      <!-- Side Container for User List -->
      <div class="online-users">
        <h2>Users</h2>
        <div id="online-users-loading" class="loading-overlay">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading users...</span>
          </div>
        </div>
        <ul id="online-users">
          {% for user in all_users %}
            <li data-username="{{ user.username }}" class="d-flex align-items-center mb-3" style="cursor:pointer;">
              <a href="{{ url_for('auth.view_profile', username=user.username) }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ user.username }}">
                <img src="{{ user.profile_picture or '/static/images/default_avatar.png' }}" alt="{{ user.username }}'s avatar" class="avatar" style="width:40px;height:40px;margin-right:0.75rem;">
              </a>
              <span class="username">{{ user.username }}</span>
              <span class="status-indicator" style="display:none;"></span>
            </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Messages Section -->
      <div class="messages-section">
        <!-- Loading Indicator for Messages -->
        <div id="messages-loading" class="loading-overlay">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading messages...</span>
          </div>
        </div>

        <div id="messages" class="messages">
          {% for message in chat_history %}
            <div class="message {% if message.username == session['username'] %}current-user{% endif %}">
              {% if message.username != session['username'] %}
                <a href="{{ url_for('auth.view_profile', username=message.username) }}">
                  <img src="{{ message.profile_picture }}" alt="{{ message.username }}'s avatar" class="avatar" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ message.username }}">
                </a>
              {% endif %}
              <div class="message-content">
                <div class="message-header">
                  <a href="{{ url_for('auth.view_profile', username=message.username) }}" class="username" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ message.username }}">
                    {{ message.username }}
                  </a>
                  <span class="timestamp">{{ message.timestamp }}</span>
                </div>
                <div class="message-text">
                  {{ message.message }}
                  {% if message.image_url %}
                    <div class="message-image">
                      <img src="{{ message.image_url }}" alt="Attached image" style="max-width: 200px; display: block; margin-top: 0.5rem;">
                    </div>
                  {% endif %}
                </div>
              </div>
              {% if message.username == session['username'] %}
                <a href="{{ url_for('auth.view_profile', username=message.username) }}">
                  <img src="{{ message.profile_picture }}" alt="{{ message.username }}'s avatar" class="avatar" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ message.username }}">
                </a>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="typing-indicator">Someone is typing...</div>

        <!-- Input Section -->
        <div class="input-section">
          <input type="text" id="message" placeholder="Type your message..." />
          <input type="file" id="image-upload" accept="image/*" style="display:none;">
          <button id="attach-button"><i class="fas fa-image"></i></button>
          <button id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Inputs for current username and room -->
  <input type="hidden" id="current-username" value="{{ session['username'] }}">
  <input type="hidden" id="room" value="{{ room }}">

  <!-- Bootstrap JS Bundle (includes Popper for tooltips) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+U3zY4AmoF6Ykvh+8t8enY4K+5q6E" 
    crossorigin="anonymous">
  </script>

  <!-- External JavaScript -->
  <script src="/static/js/chat.js"></script>
</body>
</html>
